<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Forecasting Tool</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 2rem;
            background-color: #f4f4f4;
        }
        h2 {
            color: #2c3e50;
        }
        label {
            display: block;
            margin-top: 1rem;
        }
        select, input[type="file"], button {
            margin-top: 0.5rem;
            padding: 0.5rem;
            width: 300px;
        }
        #chartContainer {
            margin-top: 2rem;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <h2>AI Forecasting Tool</h2>

    <form id="forecast-form" enctype="multipart/form-data">
        <label for="file">Upload CSV File:</label>
        <input type="file" name="file" id="file" accept=".csv" required>

        <div id="column-selects" style="display:none;">
            <label for="date_column">Select Date Column:</label>
            <select name="date_column" id="date_column" required></select>

            <label for="value_column">Select Value Column:</label>
            <select name="value_column" id="value_column" required></select>

            <label for="method">Select Forecast Method:</label>
            <select name="method" id="method" required>
                <option value="sma">Simple Moving Average (SMA)</option>
                <option value="wma">Weighted Moving Average (WMA)</option>
            </select>

            <label for="freq">Select Forecast Frequency:</label>
            <select id="freq" name="freq" required>
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
                <option value="quarterly">Quarterly</option>
                <option value="yearly">Yearly</option>
            </select>

            <label for="period">Forecast Period:</label>
            <select id="period" name="period" required>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
            </select>

            <br><br>
            <button type="submit">Generate Forecast</button>
        </div>
    </form>

    <div id="chartContainer" style="display:none;">
        <canvas id="forecastChart"></canvas>
    </div>

    <script>
        $('#file').on('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            $.ajax({
                url: '/get_columns',
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    $('#date_column, #value_column').empty();
                    response.columns.forEach(col => {
                        $('#date_column, #value_column').append(`<option value="${col}">${col}</option>`);
                    });
                    $('#column-selects').show();
                },
                error: function () {
                    alert("Failed to read file.");
                }
            });
        });

        $('#forecast-form').on('submit', function (e) {
            e.preventDefault();

            const formData = new FormData();
            formData.append('file', $('#file')[0].files[0]);
            formData.append('date_column', $('#date_column').val());
            formData.append('value_column', $('#value_column').val());
            formData.append('method', $('#method').val());
            formData.append('period', $('#period').val());
            formData.append('freq', $('#freq').val());

            $.ajax({
                url: '/forecast',
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    const labels = response.map(entry => entry.Date);
                    const values = response.map(entry => entry.Forecast);

                    const ctx = document.getElementById('forecastChart').getContext('2d');
                    if (window.forecastChart) window.forecastChart.destroy();
                    window.forecastChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Forecast',
                                data: values,
                                borderColor: 'blue',
                                backgroundColor: 'rgba(0, 0, 255, 0.1)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: true },
                                title: { display: true, text: 'Forecast Chart' }
                            }
                        }
                    });
                    $('#chartContainer').show();
                },
                error: function () {
                    alert("Error generating forecast.");
                }
            });
        });
    </script>
</body>
</html>
